---
title: "Assessment"
author: "Eleanor Harrison"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Asthma is a common condition worldwide that can be caused by prolonged indoor exposure to mould (World Health Organization, 2024). Currently, there is a lack of accurate data on the prevalence of mould in social housing, potentially making this association more serious than expected (The Scottish Parliament, 2023).

This exploratory data analysis will investigate whether living standards have an impact on the prevalence of chronic asthma. To do this, living standards will be defined by SIMD due to the associatioon of social housing with mould, and prevalence of chronic asthma will be measured by the number of prescriptions of common preventer inhalers as these are often prescribed when long or short acting bronchodilators are ineffective, suggesting severe chronic asthma.

## Data chosen for Analysis

The prescriptions assessed are those for salbutamol, beclometasone, ciclesonide, fluticasone and mometasone as they are the most commonly prescribed preventative inhalers (Vincent, 2024)

SIMD data is released every 4 years, the dataset used will be the most recent data from 2020 (Public Helath Scotland: https://www.opendata.nhs.scot/dataset/scottish-index-of-multiple-deprivation/resource/acade396-8430-4b34-895a-b3e757fa346e)

Prescriptions data used will be all months from 2020 to correspond with SIMD year in order to accurately compare the two (Public Health Scotland: https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community)

Data will be analysed by datazone as healthboard would be harder to show trends due to large variation in SIMD within them.

Data on GP Practices was also taken from 2020 to ensure datazone areas were up to date (Public Health Scotland: https://www.opendata.nhs.scot/dataset/gp-practice-contact-details-and-list-sizes/resource/42391720-7dcb-48a2-8070-b9d63b246ac6)

```{r libraries, include=FALSE}
library(tidyverse)
library(ggplot2)
library(janitor)
library(dplyr)
library(knitr)
library(kableExtra)
library(here)
library(gt)
library(sf)
```

### Loading Datasets

```{r loading data, message = FALSE}
#loading datasets with desired variables selected
#some variables have been renamed for continuity between datasets
#clean names also used for continuity
simd2020 <- read_csv(here("data/simd2020.csv")) %>% 
  clean_names() %>% 
  select(data_zone, simd2020v2country_decile) %>% 
  mutate(simd2020v2country_decile = as.factor(simd2020v2country_decile))

gp_practices <- read_csv(here("data/practice_contactdetails_oct2020-open-data.csv")) %>% 
  rename(practice_name = GPPracticeName) %>% 
  clean_names() %>% 
  select(practice_code, data_zone, hb, practice_list_size, practice_name)

#prescriptions data taken from jan-dec 2020, 
files <- list.files(here("data", "data_2020"), pattern = "csv")
all_prescriptions_2020 <- files %>% 
  map_dfr(~read_csv(here("data", "data_2020", .)))

# filtering prescriptions for desired drugs and selecting desired columns
inhaler_prescriptions <- all_prescriptions_2020 %>% 
  rename(HB = HBT) %>%
  rename(practice_code = GPPractice) %>% 
  clean_names() %>% 
  select(practice_code, bnf_item_description, number_of_paid_items)%>% 
  filter(str_detect(bnf_item_description, "SALBUTAMOL|BECLOMETASONE|CICLESONIDE|FLUTICASONE|MOMETASONE"))
```

# Initial Analysis

The three datasets used for this analysis (GP practice, SIMD and Prescriptions data) differ by the variables used for location markers therefore cannot be joined by a common factor.
Therefore SIMD and GP datasets will be joined by data zone, and GP and prescriptions datasets will be joined by practice code (this is under the assumption that the practice is in the datazone). SIMD is hence determined by GP practice location.

```{r joins, message = FALSE}
prescriptions_gp_join <- left_join(inhaler_prescriptions, gp_practices)
simd_prescriptions_gp_join <- left_join(prescriptions_gp_join, simd2020)
# some practices dont have a corresponding datazones - find later
```

### Figure 1
```{r initial plot}
simd_prescriptions_gp_join %>% 
# where SIMD is unknown, data cannot be analysed therefore removed
# Homeless Health and Resource Services was an outlier, it is not representative of the SIMD of patients and was therefore removed
  filter(simd2020v2country_decile != "NA", practice_name != "Homeless Health & Resource Services") %>% 
  group_by(practice_name) %>%
  summarise(prescriptions_pp_pgp = sum(number_of_paid_items)/max(practice_list_size), simd2020v2country_decile = first(simd2020v2country_decile),
    .groups = 'drop') %>% 
# SIMD decile is used in analysis as it shows the most variation between groups (rather than quintile)
  ggplot(aes(x = simd2020v2country_decile, y = prescriptions_pp_pgp, fill = simd2020v2country_decile)) +
  geom_boxplot() +
  guides(fill="none") +
  labs(
    x = "SIMD Country Decile",
    y = "Number of Items Dispensed per Person per GP Practice",
    title = "Number of Inhaler Prescriptions per Person per SIMD group",
    subtitle = "SIMD is shown on a scale of 1 (most deprived) to 10 (least deprived)"
  ) +
  theme_minimal()
```

##### Results 
The results show that there is a general negative trend in number of SIMD to prescriptions per person. This data aligns with our initial argument that living standards could be affecting chronic asthma.

# Personalised Athma Action Plans (PAAPs)

PAAPs are written guides that help patients with Asthma manage their condition with personal instructions in how to respond to different situations. These are very helpful for patients with chronic asthma, but they require a lot of time to put together. By assessing which GP practices have the most cases per person, resources could be better allocated to give the most affected people PAAPs, through methods such as increased GP and nurse training. 


```{r}
simd_prescriptions_gp_join %>% 
  group_by(practice_name) %>%
  summarise(prescriptions_pp_pgp = sum(number_of_paid_items)/max(practice_list_size), simd2020v2country_decile = first(simd2020v2country_decile),
    .groups = 'drop') %>% 
  slice_max(prescriptions_pp_pgp, n = 10) %>% 
  select(practice_name, prescriptions_pp_pgp, simd2020v2country_decile) %>%
  gt() %>% 
  tab_header(title ="Top 10 GP Practices with the Highest Prescription Rates for Prventative Inhalers in Scotland", 
             subtitle = "Data from Public Health Scotland (2020)") %>% 
  cols_label(practice_name = "Practice Name",
             prescriptions_pp_pgp = "Prescriptions Per Person",
             simd2020v2country_decile = "SIMD") %>% 
    cols_align(align = "center",
             columns = c(prescriptions_pp_pgp, simd2020v2country_decile)) %>% 
  fmt_number(columns = prescriptions_pp_pgp, decimals = 2) 

```

faults - some gp practices are not representative of SIMD of community eg challenging behaviour gp in 9, homeless health and resource services in 4. that doesn't change the fact they need PAAP help.

map - edinburgh heat maps for SIMD and prescriptions per datazone (done by gp location) to visualise similarities in patterns

```{r}
datazones_2011 <- st_read(here("data", "SG_DataZone_Bdry_2011.shp")) %>% 
  clean_names()

datazones_2024 <- 

gp_simd_datazones <- left_join(datazones, simd_prescriptions_gp_join)

gp_simd_datazones %>% 
  group_by(data_zone) 
  
ggplot(aes(fill = simd2020v2country_decile)) +
  geom_sf()
```

