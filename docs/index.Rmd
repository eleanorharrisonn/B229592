---
title: "Assessment"
author: "Eleanor Harrison"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Asthma is a common condition worldwide that can be caused by prolonged indoor exposure to mould (World Health Organization, 2024). Currently, there is a lack of accurate data on the prevalence of mould in social housing, potentially making this association more serious than expected (The Scottish Parliament, 2023).

This exploratory data analysis will investigate whether living standards have an impact on the prevalence of chronic asthma. To do this, living standards will be defined by SIMD due to the associatioon of social housing with mould, and prevalence of chronic asthma will be measured by the number of prescriptions of common preventer inhalers as these are often prescribed when long or short acting bronchodilators are ineffective, suggesting severe chronic asthma.

### Data chosen for Analysis

The prescriptions assessed are those for salbutamol, beclometasone, ciclesonide, fluticasone and mometasone as they are the most commonly prescribed preventative inhalers (Vincent, 2024)

SIMD data is released every 4 years, the dataset used will be the most recent data from 2020 (Public Health Scotland: https://www.opendata.nhs.scot/dataset/scottish-index-of-multiple-deprivation/resource/acade396-8430-4b34-895a-b3e757fa346e)

Prescriptions data used will be all months from 2020 to correspond with SIMD year in order to accurately compare the two (Public Health Scotland: https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community)

Data will be analysed by datazone as healthboard would be harder to show trends due to large variation in SIMD within them.

Data on GP Practices was also taken from 2020 to ensure datazone areas were up to date (Public Health Scotland: https://www.opendata.nhs.scot/dataset/gp-practice-contact-details-and-list-sizes/resource/42391720-7dcb-48a2-8070-b9d63b246ac6)

```{r libraries, include=FALSE}
library(tidyverse)
library(ggplot2)
library(janitor)
library(dplyr)
library(knitr)
library(kableExtra)
library(here)
library(gt)
library(sf)
```

### Loading Datasets

```{r loading data, message = FALSE}
#loading datasets with desired variables selected
#some variables have been renamed for continuity between datasets
#clean names also used for continuity
simd2020 <- read_csv(here("data/simd2020.csv")) %>% 
  clean_names() %>% 
  select(data_zone, simd2020v2country_decile) %>% 
  mutate(simd2020v2country_decile = as.factor(simd2020v2country_decile))

gp_practices <- read_csv(here("data/practice_contactdetails_oct2020-open-data.csv")) %>% 
  rename(practice_name = GPPracticeName) %>% 
  clean_names() %>% 
  select(practice_code, data_zone, hb, practice_list_size, practice_name, gp_cluster, postcode, hb)

#prescriptions data taken from jan-dec 2020, 
files <- list.files(here("data", "data_2020"), pattern = "csv")
all_prescriptions_2020 <- files %>% 
  map_dfr(~read_csv(here("data", "data_2020", .)))

# filtering prescriptions for desired drugs and selecting desired columns
inhaler_prescriptions <- all_prescriptions_2020 %>% 
  rename(HB = HBT) %>%
  rename(practice_code = GPPractice) %>% 
  clean_names() %>% 
  select(practice_code, bnf_item_description, number_of_paid_items)%>% 
  filter(str_detect(bnf_item_description, "SALBUTAMOL|BECLOMETASONE|CICLESONIDE|FLUTICASONE|MOMETASONE"))
```

# Comparison of Prescriptions per GP Practice

The three datasets used for this analysis (GP practice, SIMD and Prescriptions data) differ by the variables used for location markers therefore cannot be joined by a common factor.
Therefore SIMD and GP datasets will be joined by data zone, and GP and prescriptions datasets will be joined by practice code (this is under the assumption that the practice is in the datazone). The SIMDs of the populations analysed are hence determined by the location of the GP practice that they are patients of. Residuals represent the number of prescriptions per person per GP Practice.

```{r joins, message = FALSE}
prescriptions_gp_join <- left_join(inhaler_prescriptions, gp_practices)
simd_prescriptions_gp_join <- full_join(prescriptions_gp_join, simd2020) 

# new variable is created calculating the number of combined prescriptions per person per gp practice to use are a comparative variable in analysis
prescriptions_pp_analysis <-  simd_prescriptions_gp_join %>% 
  group_by(practice_name) %>%
  summarise(prescriptions_pp_pgp = sum(number_of_paid_items)/max(practice_list_size), simd2020v2country_decile = first(simd2020v2country_decile),
    .groups = 'drop')
```

## Figure 1
```{r initial plot}
prescriptions_pp_analysis %>% 
# Some practice codes are dummy practice codestherefore don't have an associated with SIMD. Data therefore cannot be analysed so is removed removed
# Homeless Health and Resource Services was an outlier in SIMD group 4, it is not representative of the SIMD of patients and was therefore removed
  filter(simd2020v2country_decile != "NA", practice_name != "Homeless Health & Resource Services") %>% 
# SIMD decile is used in analysis as it shows the most variation between groups (rather than quintile) so patterns will be easier to visualise
  ggplot(aes(x = simd2020v2country_decile, y = prescriptions_pp_pgp, fill = simd2020v2country_decile)) +
  geom_boxplot() +
  guides(fill="none") +
  labs(
    x = "SIMD Country Decile",
    y = "Number of Items Dispensed per Person per GP Practice",
    title = "Boxplot showing the correlation of SIMD to Inhaler Prescriptions",
    subtitle = "SIMD is shown on a scale of 1 (most deprived) to 10 (least deprived)",
    caption = "Residuals represent the number of prescriptions per person per GP Practice"
  ) +
  theme_minimal(base_size = 13)
```

Figure 1 shows that there is a general negative trend in SIMD to number of prescriptions per person. This data aligns with our initial argument that living standards could be affecting chronic asthma. 

# Personalised Athma Action Plan (PAAP) Resource Implementation

PAAPs are written guides that help patients with Asthma manage their condition with personal instructions in how to respond to different situations. These are very helpful for patients with chronic asthma, but they require a lot of time to put together. By assessing which GP practices have the most cases per person, resources could be better allocated to give the most affected people PAAPs, through methods such as increased GP and nurse training. 

## Figure 2
```{r}
prescriptions_pp_analysis %>% 
  slice_max(prescriptions_pp_pgp, n = 10) %>% 
  select(practice_name, prescriptions_pp_pgp, simd2020v2country_decile) %>%
  gt() %>% 
  tab_header(title ="GP Practices with the Highest Prescription Rates for Preventative Inhalers in Scotland", 
             subtitle = "Data from Public Health Scotland (2020)") %>% 
  cols_label(practice_name = md("**Practice Name**"),
             prescriptions_pp_pgp = md("**Prescriptions Per Person**"),
             simd2020v2country_decile = md("**SIMD**")) %>% 
    cols_align(align = "center",
             columns = c(prescriptions_pp_pgp, simd2020v2country_decile)) %>% 
  fmt_number(columns = prescriptions_pp_pgp, decimals = 2) %>% 
  tab_style(
    style = cell_fill(color = "#FFBBA7"),
    locations = cells_body(
      rows = practice_name %in% c("Homeless Health & Resource Services",
                                  "Challenging Behaviour General Practice"))
  )
```

Figure 2 highlights the top 10 GP Practices in Scotland with the most prescriptions for inhalers per person, therefore these practices would likely benefit the most from increased PAAP resource allocation.


```{r, message = FALSE}
# reading gp gractice location shapefile
gp_practice_shp <- st_read(here("data", "pub_gpprac.shp")) %>% 
  clean_names() %>% 
  select(postcode, geometry)

#extracting postcodes as common factor between datasets
gp_postcodes <- gp_practices %>% 
  select(practice_name, postcode, gp_cluster, hb)

#giving each gp practice its postcode
gp_simd_postcodes <- full_join(prescriptions_pp_analysis, gp_postcodes)

#combibining data with shapefile
gp_simd_point_shp <- left_join(gp_practice_shp, gp_simd_postcodes, relationship = "many-to-many")
gp_simd_shp %>% 
  group_by(gp_cluster) %>% 
  ggplot(aes(colour = simd2020v2country_decile)) +
  geom_sf() 






healthboard_shp <- st_read(here("data", "NHS_healthboards_2019.shp")) %>% 
  clean_names() %>% 
  rename(hb = hb_code)

healthboard_summary <- gp_simd_postcodes %>% 
    group_by(hb) %>% 
  summarise(prescriptions_pp_phb = mean(prescriptions_pp_pgp), simd2020v2country_decile = first(simd2020v2country_decile))

healthboard_analysis_shp <- full_join(healthboard_summary, healthboard_shp)



ggplot() +
  geom_sf(data = healthboard_analysis_shp, aes(fill = prescriptions_pp_phb, geometry = geometry), color = "black", size = 0.1) +
  geom_sf(data = gp_simd_point_shp, aes(colour = simd2020v2country_decile, geometry = geometry)) +
  scale_fill_viridis_c(option = "plasma", name = "Prescriptions per Person") +
    labs(
    title = "Overlay of Health Boards and Point Data",
    subtitle = "Visualizing health board polygons with prescription points",
    caption = "Source: Public Health Scotland 2020"
  ) +
  theme_minimal()
  






```


Heat map
group by healthboard or hspc- highlight msot in need


# Discussion

## Limitations
Figure 2 highlights the main flaw in this analysis; not every GP practice is representative of their patients' SIMD status, highlighted by the rows in orange. This is logical as only areas with sufficient resources in excess can care for deprived populations, such as those that are homeless. However, this does not change the fact that those particular GP Practices would require more aid in giving out PAAPs to their patients. Furthermore, because of the defined catchment areas of most GP Practices, this flaw likely only affects a small number of practices, which does not significantly affect the rest of the analysis. This is corroborated as only one datapoint was removed for analysis in Figure 1 and results were still conclusive. 

# References

Douglas, A.P., Smibert, Olivia.C., Bajel, A., Halliday, C.L., Lavee, O., McMullan, B., Yong, M.K., Hal, S.J., Chen, S.C. ‐A., Slavin, M.A., Thursky, K.A., Roberts, J.A., Worth, L.J., Chang, C.C., Chen, S.C., Morrissey, C.O., Blyth, C.C. and Khanina, A. (2021). Consensus guidelines for the diagnosis and management of invasive aspergillosis, 2021. Internal Medicine Journal, 51(S7), pp.143–176. doi:https://doi.org/10.1111/imj.15591.

Mousavi, B. (2016). Aspergillus species in indoor environments and their possible occupational and public health hazards. Current Medical Mycology, 2(1), pp.36–42. doi:https://doi.org/10.18869/acadpub.cmm.2.1.36.

The Scottish Parliament (2023). Local Government, Housing and Planning Committee: Damp and Mould in Social and Private Rented Housing. [online] The Scottish Parliament. Available at: https://www.parliament.scot/api/sitecore/CustomMedia/OfficialReport?meetingId=15285

.Vincent, P. (2024). Asthma Inhalers. [online] Patient.info. Available at: https://patient.info/chest-lungs/asthma-leaflet/asthma-inhalers.

World Health Organization (2024). Asthma. [online] World Health Organisation. Available at: https://www.who.int/news-room/fact-sheets/detail/asthma.

#### Generative AI Disclaimer
Generative AI has been used in this project for troubleshooting errors in code only